<!DOCTYPE html>
<html>
<head>
  <title>Study Group</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body{
      margin:0;
      font-family:Poppins,sans-serif;
      background:linear-gradient(135deg,#0f0f1a,#1a1a2e);
      color:white;
      padding:20px;
    }
    h1{text-align:center;color:#FFD700;}
    .card{
      background:#111827;
      padding:20px;
      border-radius:20px;
      margin-top:20px;
    }
    .member{
      background:#1f2937;
      padding:10px;
      border-radius:10px;
      margin-bottom:8px;
    }
    .btn{
      background:#10b981;
      border:none;
      padding:14px;
      border-radius:12px;
      width:100%;
      margin-top:15px;
      color:white;
      font-weight:bold;
      cursor:pointer;
    }
  </style>
</head>

<body>

<h1>ðŸ”¥ My Study Squad</h1>

<div class="card">
  <h3 id="groupName">Loading...</h3>
  <p id="memberCount"></p>
</div>

<div class="card">
  <h3>Members</h3>
  <div id="membersList"></div>
</div>

<button class="btn" onclick="shareGroupLink()">Invite Friends</button>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCehyZQukDfslKTY_u9yXcUrzGtMNHvuPA",
  authDomain: "his-academy.firebaseapp.com",
  projectId: "his-academy",
  storageBucket: "his-academy.firebasestorage.app",
  messagingSenderId: "573278549264",
  appId: "1:573278549264:web:ca2ff160b5a100cc7d2195",
  measurementId: "G-8WPMS7H33F"
};
  
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentGroupId = null; // ðŸ”¥ store properly

auth.onAuthStateChanged(async (user) => {

  if (!user) {
    window.location.href = "index.html";
    return;
  }

  const studentRef = db.collection("students").doc(user.uid);
  const studentDoc = await studentRef.get();
  let studentData = studentDoc.data();

  // ðŸ”¥ If no group â†’ create first
  if (!studentData.groupId) {

    const newGroupRef = await db.collection("studyGroups").add({
      groupName: studentData.name + "'s Squad",
      createdBy: user.uid,
      members: [user.uid],
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    await studentRef.update({
      groupId: newGroupRef.id
    });

    currentGroupId = newGroupRef.id;

  } else {
    currentGroupId = studentData.groupId;
  }

  // ðŸ”¥ Now groupId is guaranteed valid
  const groupDoc = await db.collection("studyGroups")
                           .doc(currentGroupId)
                           .get();

  const groupData = groupDoc.data();

  document.getElementById("groupName").innerText = groupData.groupName;
  document.getElementById("memberCount").innerText =
    "Members: " + groupData.members.length + "/10";

  const list = document.getElementById("membersList");
  list.innerHTML = "";

  for (const uid of groupData.members) {
    const memberDoc = await db.collection("students").doc(uid).get();
    const div = document.createElement("div");
    div.className = "member";
    div.innerText = memberDoc.data().name;
    list.appendChild(div);
  }

});

async function shareGroupLink() {

  if (!currentGroupId) {
    alert("Group still creating. Please wait 2 seconds.");
    return;
  }

  const baseURL =
    "https://manjunath180414-netizen.github.io/HiSAcademyWebApp/";

  const link = baseURL + "?group=" + currentGroupId;

  window.open(
    "https://api.whatsapp.com/send?text=" +
    encodeURIComponent("Join my Study Squad ðŸš€\n\n" + link),
    "_blank"
  );
}
</script>

</body>
</html>
