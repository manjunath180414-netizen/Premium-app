<!DOCTYPE html>
<html>
<head>
  <title>Study Group</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body{
      margin:0;
      font-family:Poppins,sans-serif;
      background:linear-gradient(135deg,#0f0f1a,#1a1a2e);
      color:white;
      padding:20px;
    }
    h1{text-align:center;color:#FFD700;}
    .card{
      background:#111827;
      padding:20px;
      border-radius:20px;
      margin-top:20px;
    }
    input{
      width:100%;
      padding:12px;
      margin-top:10px;
      border-radius:10px;
      border:none;
      background:#1f2937;
      color:white;
    }
    button{
      width:100%;
      padding:12px;
      margin-top:10px;
      border:none;
      border-radius:10px;
      background:#10b981;
      color:white;
      font-weight:bold;
      cursor:pointer;
    }
    .member{
      background:#1f2937;
      padding:10px;
      border-radius:10px;
      margin-bottom:8px;
    }
  </style>
</head>

<body>

<h1>ðŸ”¥ Study Group</h1>

<div id="createSection" class="card" style="display:none;">
  <h3>Create Your Group</h3>
  <p>Enter 4 digits. We will add HIS automatically.</p>
  <input type="number" id="groupDigits" placeholder="Enter 4 digits">
  <button onclick="createGroup()">Create Group</button>
</div>

<div id="groupSection" style="display:none;">

  <div class="card">
    <h3 id="groupName"></h3>
    <p id="memberCount"></p>
  </div>

  <div class="card">
    <h3>Members</h3>
    <div id="membersList"></div>
  </div>

  <button onclick="shareGroupLink()">Invite Friends</button>

</div>

<script>

const firebaseConfig = {
  apiKey: "AIzaSyCehyZQukDfslKTY_u9yXcUrzGtMNHvuPA",
  authDomain: "his-academy.firebaseapp.com",
  projectId: "his-academy",
  storageBucket: "his-academy.firebasestorage.app",
  messagingSenderId: "573278549264",
  appId: "1:573278549264:web:ca2ff160b5a100cc7d2195",
  measurementId: "G-8WPMS7H33F"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

let currentGroupId=null;

auth.onAuthStateChanged(async(user)=>{

  if(!user){
    window.location.href="index.html";
    return;
  }

  const studentRef=db.collection("students").doc(user.uid);
  const studentDoc=await studentRef.get();
  const studentData=studentDoc.data();

  // ðŸ”¥ If coming from link
  const groupFromURL=new URLSearchParams(window.location.search).get("group");

  if(groupFromURL){
    await joinGroup(user.uid,groupFromURL);
    return;
  }

  if(!studentData.groupId){
    document.getElementById("createSection").style.display="block";
  }else{
    loadGroup(studentData.groupId);
  }

});

async function createGroup(){

  const digits = document.getElementById("groupDigits").value.trim();

  if(digits.length !== 4){
    alert("Enter exactly 4 digits");
    return;
  }

  const groupId = "HIS" + digits;
  const user = auth.currentUser;

  const groupRef = db.collection("studyGroups").doc(groupId);
  const groupDoc = await groupRef.get();

  if(groupDoc.exists){
    alert("Group code already taken.");
    return;
  }

  await groupRef.set({
    groupName: groupId,
    createdBy: user.uid,
    members: [user.uid],
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  await db.collection("students").doc(user.uid).update({
    groupId: groupId
  });

  // ðŸ”¥ Immediately show group section
  showGroupUI(groupId);
}

  loadGroup(groupId);
}

async function joinGroup(uid, groupId){

  const groupRef = db.collection("studyGroups").doc(groupId);
  const groupDoc = await groupRef.get();

  if(!groupDoc.exists){
    alert("Group does not exist");
    return;
  }

  await groupRef.update({
    members: firebase.firestore.FieldValue.arrayUnion(uid)
  });

  await db.collection("students").doc(uid).update({
    groupId: groupId
  });

  showGroupUI(groupId);
  loadGroup(groupId);
}
async function showGroupUI(groupId){

  currentGroupId = groupId;

  document.getElementById("createSection").style.display = "none";
  document.getElementById("groupSection").style.display = "block";

  const groupDoc = await db.collection("studyGroups").doc(groupId).get();
  const groupData = groupDoc.data();

  document.getElementById("groupName").innerText = "Group: " + groupId;
  document.getElementById("memberCount").innerText =
    "Members: " + groupData.members.length + "/10";

  const list = document.getElementById("membersList");
  list.innerHTML = "";

  for(const uid of groupData.members){
    const memberDoc = await db.collection("students").doc(uid).get();
    const div = document.createElement("div");
    div.className = "member";
    div.innerText = memberDoc.data().name;
    list.appendChild(div);
  }
}

function shareGroupLink(){

  const baseURL="https://manjunath180414-netizen.github.io/HiSAcademyWebApp/";
  const link=baseURL+"?group="+currentGroupId;

  window.open(
    "https://api.whatsapp.com/send?text="+
    encodeURIComponent("Join my Study Squad ðŸš€\n\n"+link),
    "_blank"
  );
}

</script>

</body>
</html>
