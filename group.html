<!DOCTYPE html>
<html>
<head>
  <title>Study Group | HIS Academy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Poppins, sans-serif;
      background: linear-gradient(135deg,#0f0f1a,#1a1a2e);
      color: white;
      padding: 20px;
    }
    h1 { text-align:center; color:#FFD700; }
    .card {
      background:#111827;
      padding:20px;
      border-radius:20px;
      margin-top:20px;
      box-shadow:0 0 25px rgba(255,215,0,0.15);
    }
    .member {
      background:#1f2937;
      padding:10px;
      border-radius:10px;
      margin-bottom:8px;
    }
    .highlight { color:#FFD700; font-weight:bold; }
    .btn {
      background:#10b981;
      color:white;
      border:none;
      padding:14px;
      border-radius:12px;
      width:100%;
      font-weight:bold;
      margin-top:15px;
      cursor:pointer;
    }
  </style>
</head>

<body>

<h1>ðŸ”¥ My Study Squad</h1>

<div class="card">
  <h3 id="groupName">Loading...</h3>
  <p id="memberCount"></p>
</div>

<div class="card">
  <h3>ðŸ‘¥ Members</h3>
  <div id="membersList"></div>
</div>

<button class="btn" onclick="shareGroupLink()">âž• Invite Friends</button>

<script>

const firebaseConfig = {
  apiKey: "AIzaSyCehyZQukDfslKTY_u9yXcUrzGtMNHvuPA",
  authDomain: "his-academy.firebaseapp.com",
  projectId: "his-academy",
  storageBucket: "his-academy.firebasestorage.app",
  messagingSenderId: "573278549264",
  appId: "1:573278549264:web:ca2ff160b5a100cc7d2195",
  measurementId: "G-8WPMS7H33F"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentGroupId = null; // ðŸ”¥ important

auth.onAuthStateChanged(async (user) => {

  if (!user) {
    window.location.href = "index.html";
    return;
  }

  const studentRef = db.collection("students").doc(user.uid);
  const studentDoc = await studentRef.get();

  if (!studentDoc.exists) {
    alert("Student not found");
    return;
  }

  let studentData = studentDoc.data();

  // ðŸ”¥ If no group â†’ create
  if (!studentData.groupId) {

    const newGroupRef = await db.collection("studyGroups").add({
      groupName: studentData.name + "'s Squad",
      createdBy: user.uid,
      members: [user.uid],
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    await studentRef.update({
      groupId: newGroupRef.id
    });

    studentData.groupId = newGroupRef.id;
  }

  currentGroupId = studentData.groupId; // ðŸ”¥ save globally

  const groupDoc = await db.collection("studyGroups")
                           .doc(currentGroupId)
                           .get();

  if (!groupDoc.exists) {
    alert("Group not found");
    return;
  }

  const groupData = groupDoc.data();

  document.getElementById("groupName").innerText = groupData.groupName;
  document.getElementById("memberCount").innerHTML =
    "Members: <span class='highlight'>" +
    groupData.members.length + "/10</span>";

  const membersList = document.getElementById("membersList");
  membersList.innerHTML = "";

  for (const uid of groupData.members) {
    const memberDoc = await db.collection("students").doc(uid).get();
    if (memberDoc.exists) {
      const div = document.createElement("div");
      div.className = "member";
      div.innerText = memberDoc.data().name;
      membersList.appendChild(div);
    }
  }

});

// ðŸ”¥ SHARE LINK FIXED
function shareGroupLink() {

  if (!currentGroupId) {
    alert("Group not ready yet. Please wait.");
    return;
  }

  const baseURL = "https://manjunath180414-netizen.github.io/HiSAcademyWebApp/";
  const link = baseURL + "index.html?group=" + currentGroupId;

  const message =
    "ðŸ”¥ Join my HIS Academy Study Squad!\n\n" +
    "Study together & unlock FREE access ðŸš€\n\n" +
    link;

  window.open(
    "https://api.whatsapp.com/send?text=" +
    encodeURIComponent(message),
    "_blank"
  );
}

</script>

</body>
</html>
