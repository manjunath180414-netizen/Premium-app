<!DOCTYPE html>
<html>
<head>
  <title>HIS Academy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      margin:0;
      font-family:Poppins,sans-serif;
      background:linear-gradient(135deg,#0f0f1a,#1a1a2e);
      display:flex;
      justify-content:center;
      align-items:center;
      height:100vh;
      color:white;
    }
    .container{
      width:90%;
      max-width:400px;
      background:#111827;
      padding:30px;
      border-radius:20px;
      box-shadow:0 0 30px rgba(255,215,0,0.15);
    }
    h2{text-align:center;color:#FFD700;margin-bottom:25px;}
    input,select{
      width:100%;
      padding:12px;
      margin-bottom:15px;
      border-radius:10px;
      border:none;
      background:#1f2937;
      color:white;
    }
    .btn{
      width:100%;
      padding:12px;
      border-radius:10px;
      border:none;
      background:#FFD700;
      color:black;
      font-weight:bold;
      cursor:pointer;
      display:none;
    }
  </style>
</head>

<body>

<div class="container">
  <h2>Welcome to HIS Academy</h2>

  <input type="text" id="name" placeholder="Enter Your Name">
  <input type="tel" id="phone" placeholder="Enter Phone Number">

  <select id="medium">
    <option value="">Select Medium</option>
    <option value="English">English</option>
    <option value="Kannada">Kannada</option>
  </select>

  <button id="loginBtn" class="btn">Continue with Google</button>
</div>

<script>

const firebaseConfig = {
  apiKey: "AIzaSyCehyZQukDfslKTY_u9yXcUrzGtMNHvuPA",
  authDomain: "his-academy.firebaseapp.com",
  projectId: "his-academy",
  storageBucket: "his-academy.firebasestorage.app",
  messagingSenderId: "573278549264",
  appId: "1:573278549264:web:ca2ff160b5a100cc7d2195",
  measurementId: "G-8WPMS7H33F"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const provider = new firebase.auth.GoogleAuthProvider();

// ðŸ”¥ Get group from URL safely
let groupIdFromLink = new URLSearchParams(window.location.search).get("group");
if (!groupIdFromLink || groupIdFromLink === "undefined") {
  groupIdFromLink = null;
}

const nameInput = document.getElementById("name");
const phoneInput = document.getElementById("phone");
const mediumSelect = document.getElementById("medium");
const loginBtn = document.getElementById("loginBtn");

function checkInputs(){
  if(nameInput.value && phoneInput.value && mediumSelect.value){
    loginBtn.style.display="block";
  }else{
    loginBtn.style.display="none";
  }
}

nameInput.addEventListener("input",checkInputs);
phoneInput.addEventListener("input",checkInputs);
mediumSelect.addEventListener("change",checkInputs);

loginBtn.addEventListener("click", async ()=>{

  const result = await auth.signInWithPopup(provider);
  const user = result.user;

  const studentRef = db.collection("students").doc(user.uid);
  const studentDoc = await studentRef.get();

  if(!studentDoc.exists){

    await studentRef.set({
      name:nameInput.value,
      phone:phoneInput.value,
      email:user.email,
      medium:mediumSelect.value,
      paymentStatus:"not_paid",
      groupId:groupIdFromLink,
      joinedOn:firebase.firestore.FieldValue.serverTimestamp()
    });

    // ðŸ”¥ If joining via link â†’ add to that group
    if(groupIdFromLink){
      const groupRef = db.collection("studyGroups").doc(groupIdFromLink);
      const groupDoc = await groupRef.get();
      if(groupDoc.exists){
        await groupRef.update({
          members:firebase.firestore.FieldValue.arrayUnion(user.uid)
        });
      }
    }
  }

  window.location.href="group.html";
});

</script>

</body>
</html>
